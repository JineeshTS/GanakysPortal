# GanaPortal System Architecture

**Generated by:** ARCH-001 to ARCH-015
**Date:** 2026-01-06
**Version:** 1.0

---

## 1. System Overview

```
                                 ┌─────────────────────────────────┐
                                 │           INTERNET              │
                                 └────────────────┬────────────────┘
                                                  │
                                                  ▼
                                 ┌─────────────────────────────────┐
                                 │         NGINX (SSL/TLS)         │
                                 │       portal.ganakys.com        │
                                 └────────────────┬────────────────┘
                                                  │
                          ┌───────────────────────┼───────────────────────┐
                          │                       │                       │
                          ▼                       ▼                       ▼
              ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
              │   FRONTEND        │   │   BACKEND         │   │   STATIC ASSETS   │
              │   Next.js 14      │   │   FastAPI         │   │   /static/*       │
              │   :3000           │   │   :8000           │   │                   │
              └─────────┬─────────┘   └─────────┬─────────┘   └───────────────────┘
                        │                       │
                        │                       │
                        │             ┌─────────┴─────────┐
                        │             │                   │
                        │             ▼                   ▼
                        │   ┌─────────────────┐ ┌─────────────────┐
                        │   │   PostgreSQL    │ │     Redis       │
                        │   │   :5432         │ │     :6379       │
                        │   └─────────────────┘ └─────────────────┘
                        │
                        ▼
              ┌───────────────────────────────────────────────────────┐
              │                    AI BRAIN LAYER                      │
              │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │
              │  │ Claude  │→│ Gemini  │→│ OpenAI  │→│Together │      │
              │  │ PRIMARY │ │FALLBACK1│ │FALLBACK2│ │FALLBACK3│      │
              │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │
              └───────────────────────────────────────────────────────┘
```

## 2. Component Architecture

### 2.1 Frontend (Next.js 14)
```
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/             # Auth layout group
│   │   │   ├── login/
│   │   │   └── forgot-password/
│   │   ├── (dashboard)/        # Dashboard layout group
│   │   │   ├── layout.tsx      # Sidebar + Header
│   │   │   ├── page.tsx        # Dashboard home
│   │   │   ├── employees/
│   │   │   ├── payroll/
│   │   │   ├── accounting/
│   │   │   ├── invoices/
│   │   │   ├── bills/
│   │   │   ├── gst/
│   │   │   ├── leave/
│   │   │   ├── projects/
│   │   │   ├── crm/
│   │   │   └── settings/
│   │   └── layout.tsx          # Root layout
│   ├── components/
│   │   ├── ui/                 # shadcn/ui components
│   │   ├── shared/             # App-wide components
│   │   │   ├── DataTable.tsx
│   │   │   ├── PageHeader.tsx
│   │   │   ├── LoadingSpinner.tsx
│   │   │   └── ErrorBoundary.tsx
│   │   └── modules/            # Module-specific components
│   ├── hooks/
│   │   ├── useAuth.ts
│   │   ├── useApi.ts
│   │   └── useToast.ts
│   ├── lib/
│   │   ├── utils.ts
│   │   ├── validators.ts
│   │   └── constants.ts
│   ├── services/
│   │   ├── api.ts              # Base API client
│   │   ├── auth.ts
│   │   ├── employees.ts
│   │   ├── payroll.ts
│   │   └── ...
│   └── types/
│       ├── api.ts
│       ├── employee.ts
│       ├── payroll.ts
│       └── ...
└── package.json
```

### 2.2 Backend (FastAPI)
```
backend/
├── app/
│   ├── api/
│   │   └── v1/
│   │       ├── endpoints/
│   │       │   ├── auth.py
│   │       │   ├── employees.py
│   │       │   ├── payroll.py
│   │       │   ├── accounting.py
│   │       │   ├── invoices.py
│   │       │   ├── bills.py
│   │       │   ├── gst.py
│   │       │   ├── banking.py
│   │       │   ├── leave.py
│   │       │   ├── projects.py
│   │       │   ├── crm.py
│   │       │   ├── ai.py
│   │       │   └── ...
│   │       └── router.py
│   ├── core/
│   │   ├── config.py           # Settings
│   │   ├── security.py         # JWT, hashing
│   │   ├── deps.py             # Dependencies
│   │   └── exceptions.py
│   ├── models/
│   │   ├── base.py             # BaseModel
│   │   ├── user.py
│   │   ├── company.py
│   │   ├── employee.py
│   │   ├── payroll.py
│   │   ├── accounting.py
│   │   ├── invoice.py
│   │   ├── bill.py
│   │   └── ...
│   ├── schemas/
│   │   ├── auth.py
│   │   ├── employee.py
│   │   ├── payroll.py
│   │   └── ...
│   ├── services/
│   │   ├── auth.py
│   │   ├── employee.py
│   │   ├── payroll/
│   │   │   ├── calculator.py
│   │   │   ├── pf.py           # PF Calculator
│   │   │   ├── esi.py          # ESI Calculator
│   │   │   ├── tds.py          # TDS Calculator
│   │   │   └── pt.py           # PT Calculator
│   │   ├── accounting.py
│   │   ├── gst.py
│   │   └── ai/
│   │       ├── service.py      # AI fallback chain
│   │       ├── providers/
│   │       │   ├── claude.py
│   │       │   ├── gemini.py
│   │       │   ├── openai.py
│   │       │   └── together.py
│   │       └── document.py
│   ├── db/
│   │   ├── session.py
│   │   └── init_db.py
│   └── main.py
├── alembic/
│   ├── versions/
│   └── env.py
├── tests/
│   ├── conftest.py
│   ├── test_auth.py
│   ├── test_payroll.py
│   ├── test_compliance.py      # Critical compliance tests
│   └── ...
├── requirements.txt
└── Dockerfile
```

## 3. Security Architecture

### 3.1 Authentication Flow
```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ Client  │────▶│  Login  │────▶│  JWT    │────▶│  Redis  │
│         │     │  API    │     │  Token  │     │ Session │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
     │                               │
     │     ┌─────────────────────────┘
     │     │
     ▼     ▼
┌─────────────────────────────────────────────────────┐
│                  Protected Routes                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │ Validate    │→│ Check Role  │→│ Check       │   │
│  │ JWT Token   │ │ Permissions │ │ Company ID  │   │
│  └─────────────┘ └─────────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────┘
```

### 3.2 RBAC Matrix
| Resource | Admin | HR | Accountant | Employee | CA |
|----------|-------|-----|------------|----------|-----|
| Users | CRUD | R | R | - | - |
| Employees | CRUD | CRUD | R | Self | R |
| Payroll | CRUD | CRUD | R | Self | R |
| Invoices | CRUD | R | CRUD | - | R |
| Bills | CRUD | R | CRUD | - | R |
| GST | CRUD | - | CRUD | - | RU |
| Reports | R | R | R | - | R |

### 3.3 Row-Level Security
```sql
-- All tenant tables include company_id
CREATE POLICY company_isolation ON employees
  USING (company_id = current_setting('app.current_company_id')::uuid);
```

## 4. AI Architecture

### 4.1 Fallback Chain
```python
class AIService:
    PROVIDERS = [
        ("claude-3-5-sonnet-20241022", ClaudeProvider),
        ("gemini-1.5-pro", GeminiProvider),
        ("gpt-4-turbo", OpenAIProvider),
        ("Llama-3-70b", TogetherProvider),
    ]

    async def complete(self, prompt: str) -> AIResponse:
        for model, provider_class in self.PROVIDERS:
            try:
                provider = provider_class()
                return await provider.complete(prompt)
            except ProviderError as e:
                logger.warning(f"{model} failed: {e}")
                continue
        raise AllProvidersFailedError()
```

### 4.2 Confidence Thresholds
```python
class ConfidenceLevel(Enum):
    AUTO_EXECUTE = 95     # >= 95%: Auto-execute
    QUEUE_REVIEW = 70     # 70-94%: Queue for review
    MANUAL = 0            # < 70%: Manual processing

def process_ai_decision(confidence: float, action: Action):
    if confidence >= ConfidenceLevel.AUTO_EXECUTE:
        return execute_action(action)
    elif confidence >= ConfidenceLevel.QUEUE_REVIEW:
        return queue_for_review(action, confidence)
    else:
        return flag_for_manual(action, confidence)
```

## 5. Data Flow

### 5.1 Payroll Processing
```
Employee Data → Salary Structure → Gross Calculation
                                         │
                    ┌────────────────────┴────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
            ┌───────────┐        ┌───────────┐        ┌───────────┐
            │    PF     │        │    ESI    │        │    TDS    │
            │Calculator │        │Calculator │        │Calculator │
            └─────┬─────┘        └─────┬─────┘        └─────┬─────┘
                  │                    │                    │
                  └────────────────────┴────────────────────┘
                                       │
                                       ▼
                               Net Salary + Payslip
                                       │
                                       ▼
                               Journal Entries (Auto)
```

### 5.2 Invoice Flow
```
Customer → Invoice Created → GST Calculated → PDF Generated
                                   │
                                   ▼
                           Journal Entry (AR)
                                   │
                                   ▼
                           GSTR-1 Data Updated
```

---

*Architecture designed by ARCH-001 to ARCH-015 | GanaPortal Agent Army*
